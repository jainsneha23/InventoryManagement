<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-datatable/paper-datatable-card.html">
<dom-module id="product-page">
  <template>
    <style include="shared-styles">
    :host {
      display: block;
      padding: 10px;
    }
    </style>
    <div class="card">
      <paper-datatable-card id="datatableCard" data-source={{dataSource}} id-property="item_id" header="Product" selected-ids={{selectedIds}} editable>
        <div toolbar-select>
          <paper-icon-button icon="delete" on-tap="deleteSelected"></paper-icon-button>
        </div>
        <div toolbar-select-single>
          <paper-icon-button icon="datatable:editable"></paper-icon-button>
        </div>
        <paper-datatable selectable on-row-tap="editSelected">
          <div no-results>
            Loading or no more items...
          </div>
          <paper-datatable-column header="ID" property="item_id" sortable>
          </paper-datatable-column>
          <paper-datatable-column header="Name" property="name" type="String" sortable>
          </paper-datatable-column>
          <paper-datatable-column header="Quality" property="quality">
          </paper-datatable-column>
          <paper-datatable-column header="Unit" property="unit" sortable>
          </paper-datatable-column>
          <paper-datatable-column header="Description" property="description">
          </paper-datatable-column>
        </paper-datatable>
      </paper-datatable-card>
    </div>
  </template>
  <script>
  function ajaxCall(method, url, data, format) {
    return new Promise(function(resolve, reject) {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
          if (xhr.status == 200) {
            resolve(format === 'json' ? JSON.parse(xhr.responseText) : xhr.responseText);
          } else reject(xhr.responseText);
        }
      };
      xhr.open(method, url, true);
      xhr.send(data);
    });
  }
  Polymer({
    is: 'product-page',
    properties: {
      dataSource: {
        notify: true,
        value: function() {
          return this._dataSource;
        }
      },
      selectedIds: []
    },
    deleteSelected: function() {
      var self = this;
      this.selectedIds.forEach((id) => {
        ajaxCall('POST', `http://localhost:3000/product/delete/${id}`).then(function(res) {
          self.$.datatableCard.retrieveVisibleData();
          self.$.datatableCard.deselectAll();
        });
      });
    },
    editSelected: function() {
      if (app.isDebouncerActive('dblclick' + ev.detail.item.id)) {
        //double click
        app.$.datatableCard.deselectAll();
        app.$.datatableCard.select(ev.detail.item.id);
        this.$.editDialog.opened = true;
        ev.preventDefault();
        app.cancelDebouncer('dblclick');
      } else {
        app.debounce('dblclick' + ev.detail.item.id, function() {}, 300);
      }
    },
    _dataSource: {
      get: function() {
        return ajaxCall('GET', 'http://localhost:3000/product', null, 'json');
      }
    }
  });
  </script>
</dom-module>
